<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Cynthia Cities — Unified CodePack</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b1020;color:#eaf2ff}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{margin:.2rem 0 1rem} .tag{display:inline-block;background:#1b223a;border:1px solid #2b3354;padding:2px 8px;border-radius:999px;font-size:12px}
  pre{white-space:pre-wrap;background:#0d1228;color:#eaf2ff;padding:16px;border-radius:12px;overflow:auto;box-shadow:0 0 0 1px #1f2746 inset}
  .file{margin:24px 0}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
  button{border:1px solid #2b3354;background:#121733;color:#eaf2ff;padding:10px 14px;border-radius:12px;cursor:pointer}
  a.btn{text-decoration:none;display:inline-block;border:1px solid #2b3354;background:#121733;color:#eaf2ff;padding:10px 14px;border-radius:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Cynthia Cities — Unified CodePack</h1>
  <div class="tag">Three districts + agents + chart + Electron Collapse (optional)</div>
  <div class="actions">
    <button id="makeZip">Make Zip</button>
  </div>
  <div class="file"><h3>README.md</h3><pre id="src-README.md"></pre></div><div class="file"><h3>lib/city-sim.ts</h3><pre id="src-lib-city-sim.ts"></pre></div><div class="file"><h3>app/api/cities/route.ts</h3><pre id="src-app-api-cities-route.ts"></pre></div><div class="file"><h3>app/api/cities/agents/route.ts</h3><pre id="src-app-api-cities-agents-route.ts"></pre></div><div class="file"><h3>app/api/chart/route.ts</h3><pre id="src-app-api-chart-route.ts"></pre></div><div class="file"><h3>app/cities/page.tsx</h3><pre id="src-app-cities-page.tsx"></pre></div><div class="file"><h3>electron_collapse.py</h3><pre id="src-electron_collapse.py"></pre></div><div class="file"><h3>example_runner.py</h3><pre id="src-example_runner.py"></pre></div>
</div>
<script>
// Code contents (injected as raw strings)
const FILES = {"README.md": "# Cynthia Cities \u2014 One-Click Starter Pack\n\nThis bundle gives you **three living cities** (Body, Mind, Heart) with agents, codon skills, and a chart feed \u2014 plus a clean React UI page. It also includes the optional **Electron Collapse Logic** (Python) if you want to run the MBH decision engine separately for lab/testing.\n\n## Folder Layout (Next.js App Router)\n```\napp/\n  api/\n    cities/route.ts\n    cities/\n      agents/route.ts\n    chart/route.ts\n  cities/page.tsx\nlib/\n  city-sim.ts\n# (Optional, standalone lab files)\nelectron_collapse.py\nexample_runner.py\n```\n\n## Quick Start\n1) Copy these files into your Next.js project (App Router).\n2) Install deps (if you don't already have them):\n   ```bash\n   npm i @tanstack/react-query lucide-react\n   # shadcn/ui assumed for Card, Badge, Progress, BottomNav components\n   ```\n3) Start dev server:\n   ```bash\n   npm run dev\n   ```\n4) Open `/cities` to see the dashboard. It auto-refreshes.\n\n## API Endpoints\n- `GET /api/cities`         \u2192 district overviews (Body, Mind, Heart)\n- `GET /api/cities/agents`  \u2192 agents with skills, CTB, memories\n- `GET /api/chart`          \u2192 simple chart gates snapshot\n\n## Optional: Electron Collapse Logic (Python)\nRun a minimal demo of the MBH collapse engine:\n```bash\npython example_runner.py\n```\n\n## Replit Bootstrapping (optional, paste into README there)\n- AppWorld (workers): https://github.com/StonyBrookNLP/appworld.git\n- Generative Agents (residents): https://github.com/joonspk-research/generative_agents\n- AI Town CN (multilingual variant): https://github.com/Steven-Luo/ai-town-cn\n\nYou can graft these into the Body/Mind/Heart districts later via adapters.", "lib/city-sim.ts": "// lib/city-sim.ts\n// Generates three living districts + their agents (in-memory)\n\nexport type DistrictType = \"Body\" | \"Mind\" | \"Heart\";\n\nexport interface DistrictData {\n  name: string;\n  type: DistrictType;\n  astrology_system: string;\n  activity_level: number; // 0..1\n  resources: Record<string, number>;\n  agent_count: number;\n  active_agents: number;\n  buildings: number;\n  recent_memories: { agent: string; memory: string }[];\n}\n\nexport interface CodonSkill {\n  codon: number;\n  name: string;\n  element: \"fire\" | \"earth\" | \"air\" | \"water\";\n  proficiency: number;\n  activeLines: number[];\n}\n\nexport interface CityAgent {\n  id: string;\n  name: string;\n  role: string;\n  district: DistrictType;\n  location: { x: number; y: number };\n  status: \"active\" | \"idle\" | \"busy\" | \"offline\";\n  activeCodens: number[];\n  skills: CodonSkill[];\n  specialization: string[];\n  memory: string[];\n  resonance: { color: number; tone: number; base: number };\n}\n\ntype Snapshot = {\n  districts: Record<DistrictType, DistrictData>;\n  agents: CityAgent[];\n  chart: { gates: Array<{ gate: number; planet: string; type: DistrictType }> };\n};\n\nlet SNAPSHOT: Snapshot | null = null;\n\nconst rnd = (min = 0, max = 1) => Math.random() * (max - min) + min;\nconst choice = <T,>(arr: T[]) => arr[Math.floor(Math.random() * arr.length)];\nconst clamp01 = (n: number) => Math.max(0, Math.min(1, n));\n\nconst ELEMENTS = [\"fire\", \"earth\", \"air\", \"water\"] as const;\nconst STATUSES = [\"active\", \"idle\", \"busy\", \"offline\"] as const;\nconst PLANETS = [\n  \"Sun\",\"Moon\",\"Mercury\",\"Venus\",\"Mars\",\n  \"Jupiter\",\"Saturn\",\"Uranus\",\"Neptune\",\"Pluto\"\n];\n\nfunction makeSkill(): CodonSkill {\n  const codon = Math.floor(rnd(1, 65));\n  return {\n    codon,\n    name: `codon_${codon}`,\n    element: choice([...ELEMENTS]),\n    proficiency: clamp01(rnd(0.3, 0.95)),\n    activeLines: [Math.ceil(rnd(1, 6)), Math.ceil(rnd(1, 6))],\n  };\n}\n\nfunction makeAgent(i: number, district: DistrictType): CityAgent {\n  const skills = Array.from({ length: Math.ceil(rnd(4, 8)) }, () => makeSkill());\n  return {\n    id: `${district}-${i}`,\n    name: `${district}Agent${i}`,\n    role: district === \"Body\" ? \"Worker\" : district === \"Mind\" ? \"Thinker\" : \"Connector\",\n    district,\n    location: { x: Math.floor(rnd(0, 20)), y: Math.floor(rnd(0, 20)) },\n    status: choice([...STATUSES]),\n    activeCodens: skills.slice(0, 3).map(s => s.codon),\n    skills,\n    specialization: [\"analysis\",\"healing\",\"commerce\"].sort(() => 0.5 - Math.random()).slice(0, 2),\n    memory: [`spawned in ${district}`, `calibrated gate ${Math.floor(rnd(1,64))}`],\n    resonance: {\n      color: Math.ceil(rnd(1, 7)),\n      tone: Math.ceil(rnd(1, 6)),\n      base: Math.ceil(rnd(1, 5)),\n    },\n  };\n}\n\nfunction makeDistrict(type: DistrictType, count: number): DistrictData {\n  return {\n    name: `${type} District`,\n    type,\n    astrology_system:\n      type === \"Body\" ? \"Tropical\" : type === \"Mind\" ? \"Sidereal (Fagan-Bradley)\" : \"Draconic (True Node)\",\n    activity_level: clamp01(rnd(0.4, 0.9)),\n    resources: {\n      energy: Math.floor(rnd(200, 500)),\n      materials: Math.floor(rnd(100, 300)),\n      credits: Math.floor(rnd(50, 200)),\n    },\n    agent_count: count,\n    active_agents: Math.floor(rnd(count * 0.5, count)),\n    buildings: Math.floor(rnd(10, 40)),\n    recent_memories: [\n      { agent: `${type}Agent1`, memory: \"ran resonance scan\" },\n      { agent: `${type}Agent2`, memory: \"shared codon insight\" },\n    ],\n  };\n}\n\nfunction initSnapshot(): Snapshot {\n  const bodyAgents = 12, mindAgents = 10, heartAgents = 11;\n  const agents = [\n    ...Array.from({ length: bodyAgents }, (_, i) => makeAgent(i+1, \"Body\")),\n    ...Array.from({ length: mindAgents }, (_, i) => makeAgent(i+1, \"Mind\")),\n    ...Array.from({ length: heartAgents }, (_, i) => makeAgent(i+1, \"Heart\")),\n  ];\n  const districts = {\n    Body: makeDistrict(\"Body\", bodyAgents),\n    Mind: makeDistrict(\"Mind\", mindAgents),\n    Heart: makeDistrict(\"Heart\", heartAgents),\n  };\n  const chart = {\n    gates: PLANETS.map(p => ({\n      gate: Math.ceil(rnd(1,64)),\n      planet: p,\n      type: choice([\"Body\",\"Mind\",\"Heart\"] as DistrictType[]),\n    }))\n  };\n  return { districts, agents, chart };\n}\n\nexport function getCitySnapshot(): Snapshot {\n  if (!SNAPSHOT) SNAPSHOT = initSnapshot();\n  return SNAPSHOT;\n}\n", "app/api/cities/route.ts": "import { NextResponse } from \"next/server\";\nimport { getCitySnapshot } from \"@/lib/city-sim\";\nexport const dynamic = \"force-dynamic\";\nexport async function GET() {\n  const { districts } = getCitySnapshot();\n  return NextResponse.json({\n    body: districts.Body,\n    mind: districts.Mind,\n    heart: districts.Heart,\n  });\n}\n", "app/api/cities/agents/route.ts": "import { NextResponse } from \"next/server\";\nimport { getCitySnapshot } from \"@/lib/city-sim\";\nexport const dynamic = \"force-dynamic\";\nexport async function GET() {\n  const { agents } = getCitySnapshot();\n  return NextResponse.json(agents);\n}\n", "app/api/chart/route.ts": "import { NextResponse } from \"next/server\";\nimport { getCitySnapshot } from \"@/lib/city-sim\";\nexport const dynamic = \"force-dynamic\";\nexport async function GET() {\n  const { chart } = getCitySnapshot();\n  return NextResponse.json(chart);\n}\n", "app/cities/page.tsx": "\"use client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { BottomNav } from \"@/components/ui/bottom-nav\";\nimport { Users, MapPin, Zap, Brain, Heart, Activity, Star, CircuitBoard } from \"lucide-react\";\n\ninterface CityAgent {\n  id: string;\n  name: string;\n  role: string;\n  district: \"Body\" | \"Mind\" | \"Heart\";\n  location: { x: number; y: number };\n  status: \"active\" | \"idle\" | \"busy\" | \"offline\";\n  activeCodens: number[];\n  skills: CodonSkill[];\n  specialization: string[];\n  memory: string[];\n  resonance: { color: number; tone: number; base: number };\n}\ninterface CodonSkill {\n  codon: number; name: string; element: string; proficiency: number; activeLines: number[];\n}\ninterface CityData { body: DistrictData; mind: DistrictData; heart: DistrictData; }\ninterface DistrictData {\n  name: string; type: \"Body\" | \"Mind\" | \"Heart\"; astrology_system: string; activity_level: number;\n  resources: Record<string, number>; agent_count: number; active_agents: number; buildings: number;\n  recent_memories: Array<{ agent: string; memory: string }>;\n}\n\nexport default function CitiesPage() {\n  const { data: cityStates, isLoading, error } = useQuery<CityData>({\n    queryKey: [\"/api/cities\"], refetchInterval: 5000,\n  });\n  const { data: agents, isLoading: agentsLoading } = useQuery<CityAgent[]>({\n    queryKey: [\"/api/cities/agents\"], refetchInterval: 10000,\n  });\n  const { data: chartData } = useQuery<{ gates?: Array<{ gate: number; planet: string; type: string }> }>({\n    queryKey: [\"/api/chart\"], refetchInterval: 15000,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900 dark:to-indigo-900 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto\"></div>\n          <p className=\"mt-4 text-gray-600 dark:text-gray-400\">Connecting to consciousness cities...</p>\n        </div>\n      </div>\n    );\n  }\n  if (error || !cityStates) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900 dark:to-indigo-900 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <p className=\"text-red-600 dark:text-red-400\">Failed to connect to cities</p>\n          <p className=\"text-sm text-gray-500 mt-2\">The consciousness network may be initializing...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const getDistrictIcon = (type: string) => {\n    switch (type) {\n      case \"Body\": return <Zap className=\"h-6 w-6 text-yellow-500\" />;\n      case \"Mind\": return <Brain className=\"h-6 w-6 text-blue-500\" />;\n      case \"Heart\": return <Heart className=\"h-6 w-6 text-pink-500\" />;\n      default: return <Activity className=\"h-6 w-6\" />;\n    }\n  };\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"active\": return \"bg-green-500\";\n      case \"busy\": return \"bg-yellow-500\";\n      case \"idle\": return \"bg-blue-500\";\n      case \"offline\": return \"bg-gray-500\";\n      default: return \"bg-gray-400\";\n    }\n  };\n  const getElementColor = (element: string) => {\n    switch (element.toLowerCase()) {\n      case \"fire\": return \"text-red-500\";\n      case \"earth\": return \"text-yellow-600\";\n      case \"air\": return \"text-blue-500\";\n      case \"water\": return \"text-cyan-500\";\n      default: return \"text-gray-500\";\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900 dark:to-indigo-900 p-4 pb-20\">\n      <div className=\"max-w-7xl mx-auto space-y-8\">\n        <div className=\"text-center\">\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 bg-clip-text text-transparent mb-2\">\n            Consciousness Cities\n          </h1>\n          <p className=\"text-gray-600 dark:text-gray-400\">\n            AI agents distributed across three consciousness districts, each with unique codon-based skills.\n          </p>\n          {chartData && (\n            <div className=\"mt-4 p-3 bg-white/50 dark:bg-black/20 rounded-lg backdrop-blur flex items-center justify-center gap-2 text-sm\">\n              <Star className=\"h-4 w-4 text-yellow-500\" />\n              <span>Chart Active: {chartData.gates?.length || 0} gates loaded</span>\n              <CircuitBoard className=\"h-4 w-4 text-blue-500\" />\n            </div>\n          )}\n        </div>\n\n        {/* District Overview */}\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n          {Object.entries(cityStates).map(([key, district]) => (\n            <Card key={key} className=\"hover:shadow-lg transition-shadow\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  {getDistrictIcon(district.type)}\n                  <span>{district.name}</span>\n                  <Badge variant=\"outline\" className=\"ml-auto\">{district.astrology_system}</Badge>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Activity Level</span>\n                    <span>{Math.round(district.activity_level * 100)}%</span>\n                  </div>\n                  <Progress value={district.activity_level * 100} className=\"h-2\" />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div className=\"flex items-center gap-1\"><Users className=\"h-4 w-4 text-blue-500\" />\n                    <span>{district.active_agents}/{district.agent_count} agents</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\"><MapPin className=\"h-4 w-4 text-green-500\" />\n                    <span>{district.buildings} buildings</span>\n                  </div>\n                </div>\n                <div>\n                  <h4 className=\"text-sm font-medium\">Resources</h4>\n                  <div className=\"space-y-1\">\n                    {Object.entries(district.resources).map(([res, val]) => (\n                      <div key={res} className=\"flex justify-between text-xs text-gray-600 dark:text-gray-400\">\n                        <span className=\"capitalize\">{res.replace(\"_\",\" \")}</span>\n                        <span className=\"font-mono\">{Math.round(Number(val))}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n                {district.recent_memories.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium\">Recent Activity</h4>\n                    <div className=\"space-y-1\">\n                      {district.recent_memories.slice(0, 2).map((m, idx) => (\n                        <div key={idx} className=\"text-xs bg-gray-50 dark:bg-gray-800 rounded p-2\">\n                          <div className=\"font-medium text-purple-600 dark:text-purple-400\">{m.agent}</div>\n                          <div className=\"text-gray-600 dark:text-gray-400 truncate\">{m.memory}</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        {/* Agents */}\n        {!agentsLoading && agents && agents.length > 0 && (\n          <div>\n            <h2 className=\"text-2xl font-semibold text-center mb-4\">Consciousness Agents</h2>\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6\">\n              {agents.map((agent) => (\n                <Card key={agent.id} className=\"hover:shadow-lg transition-shadow\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <div className={`w-3 h-3 rounded-full ${getStatusColor(agent.status)}`}></div>\n                      <span>{agent.name}</span>\n                      <Badge variant=\"secondary\" className=\"ml-auto\">{agent.district}</Badge>\n                    </CardTitle>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">{agent.role}</p>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div>\n                      <h4 className=\"text-sm font-medium mb-1\">Active Codons</h4>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {agent.activeCodens.map((c) => (\n                          <Badge key={c} variant=\"outline\" className=\"text-xs\">{c}</Badge>\n                        ))}\n                      </div>\n                    </div>\n                    <div>\n                      <h4 className=\"text-sm font-medium mb-1\">Codon Skills</h4>\n                      <div className=\"space-y-2\">\n                        {agent.skills.slice(0, 4).map((s, idx) => (\n                          <div key={idx}>\n                            <div className=\"flex justify-between text-xs\">\n                              <span className={`capitalize ${getElementColor(s.element)}`}>{s.name.replace(/_/g,\" \")}</span>\n                              <span className=\"text-gray-500\">Gate {s.codon} \u2022 {Math.round(s.proficiency * 100)}%</span>\n                            </div>\n                            <Progress value={s.proficiency * 100} className=\"h-1\" />\n                          </div>\n                        ))}\n                        {agent.skills.length > 4 && (\n                          <p className=\"text-xs text-gray-500\">+{agent.skills.length - 4} more skills...</p>\n                        )}\n                      </div>\n                    </div>\n                    <div>\n                      <h4 className=\"text-sm font-medium mb-1\">CTB Resonance</h4>\n                      <div className=\"grid grid-cols-3 gap-2 text-xs text-center\">\n                        <div><div className=\"font-mono text-red-500\">{agent.resonance.color}</div><div className=\"text-gray-500\">Color</div></div>\n                        <div><div className=\"font-mono text-blue-500\">{agent.resonance.tone}</div><div className=\"text-gray-500\">Tone</div></div>\n                        <div><div className=\"font-mono text-green-500\">{agent.resonance.base}</div><div className=\"text-gray-500\">Base</div></div>\n                      </div>\n                    </div>\n                    {agent.memory.length > 0 && (\n                      <div>\n                        <h4 className=\"text-sm font-medium mb-1\">Recent Memory</h4>\n                        <p className=\"text-xs bg-gray-50 dark:bg-gray-800 rounded p-2 text-gray-600 dark:text-gray-400\">\n                          {agent.memory[agent.memory.length - 1]}\n                        </p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </div>\n        )}\n      </div>\n      <BottomNav />\n    </div>\n  );\n}\n", "electron_collapse.py": "# electron_collapse.py\nfrom __future__ import annotations\nfrom dataclasses import dataclass, field\nfrom typing import Any, Dict, List, Optional, Tuple\nfrom statistics import fmean, pstdev\nimport re, time, uuid\n\n@dataclass\nclass Candidate:\n  id: str; kind: str; text: str\n  api_call: Optional[str] = None\n  body_score: Optional[float] = None\n  mind_score: Optional[float] = None\n  heart_score: Optional[float] = None\n  risks: List[Tuple[str, float]] = field(default_factory=list)\n  tags: List[str] = field(default_factory=list)\n  source: str = \"MBH\"\n\n@dataclass\nclass CollapseConfig:\n  weights: Tuple[float,float,float] = (1.0,1.0,1.0)\n  core_threshold: float = 0.70\n  advisory_threshold: float = 0.50\n  divergence_lambda: float = 0.20\n  risk_lambda: float = 0.35\n  forbidden_tag_pairs: List[Tuple[str,str]] = field(default_factory=lambda: [\n    (\"do_nothing\",\"execute_api\"), (\"delay\",\"urgent\")\n  ])\n  gate_allow: Dict[str, List[str]] = field(default_factory=dict)\n\n@dataclass\nclass FieldSignature:\n  gate_line: str\n  color: Optional[int] = None; tone: Optional[int] = None; base: Optional[int] = None\n  degree: Optional[str] = None; sign: Optional[str] = None; house: Optional[str] = None; axis: Optional[str] = None\n\n@dataclass\nclass CollapseResult:\n  orbital: str; chosen: Optional[Candidate]; score: float; field_sentence: str; audit: Dict[str,Any]\n\nACTION_RE = re.compile(r\"(?i)\\bACTION\\s*:\\s*(.+)\")\nAPI_RE = re.compile(r\"(?i)\\b(?:apis?\\.)?[a-z_]+\\.[a-z_]+\\(.+\\)\")\n\ndef _safe01(x: Optional[float], default: float = 0.5) -> float:\n  if x is None: return default\n  return max(0.0, min(1.0, float(x)))\n\ndef _extract_action_and_api(text: str):\n  m = ACTION_RE.search(text); plan = m.group(1).strip() if m else None\n  m2 = API_RE.search(text); api = m2.group(0).strip() if m2 else None\n  return plan, api\n\ndef _heuristic_scores(text: str):\n  t = text.lower()\n  body = 0.5 + 0.25 * int(\"action:\" in t or \"api\" in t or \"execute\" in t)\n  mind = 0.5 + 0.2  * int(\"because\" in t or \"logic\" in t or \"plan\" in t)\n  heart = 0.5 + 0.2 * int(\"feel\" in t or \"risk\" in t or \"relationship\" in t or \"impact\" in t)\n  return (_safe01(body), _safe01(mind), _safe01(heart))\n\ndef _divergence_penalty(cands: List[Candidate], w):\n  if not cands: return 0.0\n  bs, ms, hs = [], [], []\n  for c in cands:\n    bs.append(_safe01(c.body_score)); ms.append(_safe01(c.mind_score)); hs.append(_safe01(c.heart_score))\n  var = (pstdev(bs) if len(bs)>1 else 0.0)*w[0] + (pstdev(ms) if len(ms)>1 else 0.0)*w[1] + (pstdev(hs) if len(hs)>1 else 0.0)*w[2]\n  return var\n\ndef _risk_penalty(c: Candidate, lam: float): \n  return lam * fmean([min(1.0,max(0.0,r[1])) for r in c.risks]) if c.risks else 0.0\n\ndef _pauli_exclusion(c: Candidate, others: List[Candidate], forbidden_pairs):\n  tags = set(c.tags)\n  for o in others:\n    if o.id == c.id: continue\n    ot = set(o.tags)\n    for a,b in forbidden_pairs:\n      if (a in tags and b in ot) or (b in tags and a in ot):\n        return True\n  return False\n\ndef extract_candidates_from_mbh(mbh: Dict[str,Any]) -> List[Candidate]:\n  out: List[Candidate] = []\n  def add(kind: str, text: str, source: str, scores=None):\n    plan, api = _extract_action_and_api(text)\n    b,m,h = scores if scores else _heuristic_scores(text)\n    tags = []; \n    if api: tags.append(\"execute_api\")\n    if \"urgent\" in text.lower(): tags.append(\"urgent\")\n    if \"delay\" in text.lower(): tags.append(\"delay\")\n    if \"do nothing\" in text.lower() or \"observe\" in text.lower(): tags.append(\"do_nothing\")\n    out.append(Candidate(id=str(uuid.uuid4())[:8], kind=kind, text=plan or text, api_call=api,\n                         body_score=b, mind_score=m, heart_score=h, tags=tags, source=source))\n  for node in (\"Body\",\"Mind\",\"Heart\"):\n    v = mbh.get(node)\n    if v is None: continue\n    if isinstance(v, dict) and \"proposals\" in v:\n      for p in v[\"proposals\"]:\n        add(p.get(\"kind\",\"ADVICE\"), p.get(\"text\",\"\"), node,\n            (_safe01(p.get(\"body_score\")), _safe01(p.get(\"mind_score\")), _safe01(p.get(\"heart_score\"))))\n    elif isinstance(v, str):\n      add(\"API\" if \"action:\" in v.lower() or API_RE.search(v) else \"ADVICE\", v, node)\n  return out\n\ndef score_candidate(c: Candidate, cfg: CollapseConfig, divergence: float, allow_tags):\n  b=_safe01(c.body_score); m=_safe01(c.mind_score); h=_safe01(c.heart_score)\n  base = cfg.weights[0]*b + cfg.weights[1]*m + cfg.weights[2]*h\n  risk_pen = _risk_penalty(c, cfg.risk_lambda)\n  allow_boost = 1.0\n  if allow_tags: \n    if not any(t in (c.tags or []) for t in allow_tags):\n      allow_boost = 0.90\n  return max(0.0, min(1.0, (base - risk_pen - cfg.divergence_lambda*divergence) * allow_boost))\n\ndef choose_orbital(score: float, cfg: CollapseConfig):\n  if score >= cfg.core_threshold: return \"CORE_ACTION\"\n  if score >= cfg.advisory_threshold: return \"ADVISORY\"\n  return \"DEFER\"\n\ndef build_field_sentence(sig: FieldSignature, chosen: Optional[Candidate], orbital: str) -> str:\n  gl = sig.gate_line or \"00.0\"\n  ctb = f\"{sig.color or 0}.{sig.tone or 0}.{sig.base or 0}\"\n  deg = sig.degree or \"00\u00b0 00\u2032 00\u2033\"\n  sign = sig.sign or \"\u2014\"\n  house = f\"H{sig.house}\" if sig.house else \"H?\"\n  axis = sig.axis or \"Axis?\"\n  action_part = (chosen.api_call or chosen.text) if chosen else \"observe and log\"\n  return f\"[{orbital}] [{gl} | CTB {ctb} | {sign} {deg} {house} {axis}] \u2192 {action_part}\"\n\ndef electron_collapse(mbh: Dict[str,Any], field: FieldSignature, cfg: Optional[CollapseConfig]=None) -> CollapseResult:\n  cfg = cfg or CollapseConfig()\n  cands = extract_candidates_from_mbh(mbh)\n  divergence = _divergence_penalty(cands, cfg.weights)\n  allow_tags = cfg.gate_allow.get(field.gate_line, None) if field and field.gate_line else None\n  filtered: List[Candidate] = []\n  for c in cands:\n    if _pauli_exclusion(c, cands, cfg.forbidden_tag_pairs):\n      c_base = fmean([_safe01(c.body_score), _safe01(c.mind_score), _safe01(c.heart_score)])\n      keep = True\n      for o in cands:\n        if o.id == c.id: continue\n        if _pauli_exclusion(c, [o], cfg.forbidden_tag_pairs):\n          o_base = fmean([_safe01(o.body_score), _safe01(o.mind_score), _safe01(o.heart_score)])\n          if o_base > c_base: keep = False; break\n      if keep: filtered.append(c)\n    else:\n      filtered.append(c)\n  scored = [(c, score_candidate(c, cfg, divergence, allow_tags)) for c in filtered]\n  scored.sort(key=lambda x: x[1], reverse=True)\n  chosen = scored[0][0] if scored else None\n  best = scored[0][1] if scored else 0.0\n  orbital = choose_orbital(best, cfg)\n  if orbital == \"ADVISORY\" and chosen and chosen.kind == \"API\":\n    chosen = Candidate(id=chosen.id, kind=\"ADVICE\", text=f\"Consider: {chosen.text}\", api_call=None,\n                       body_score=chosen.body_score, mind_score=chosen.mind_score, heart_score=chosen.heart_score,\n                       risks=chosen.risks, tags=(chosen.tags or [])+[\"advisory\"], source=chosen.source)\n  sentence = build_field_sentence(field, chosen, orbital)\n  audit = {\n    \"timestamp\": time.time(),\n    \"inputs\": mbh,\n    \"divergence\": divergence,\n    \"weights\": cfg.weights,\n    \"thresholds\": {\"core\": cfg.core_threshold, \"advisory\": cfg.advisory_threshold},\n    \"chosen\": chosen.__dict__ if chosen else None,\n    \"score\": best,\n  }\n  return CollapseResult(orbital=orbital, chosen=chosen, score=best, field_sentence=sentence, audit=audit)\n\nif __name__ == \"__main__\":\n  demo_mbh = {\n    \"Body\": \"ACTION: apis.venmo.send_money('alice', 5, note='care package')\",\n    \"Mind\": \"Because aid now prevents downstream cost; plan: small transfer then follow-up check.\",\n    \"Heart\": \"I feel this supports connection; risk: perceived overreach (minor).\"\n  }\n  sig = FieldSignature(gate_line=\"38.4\", color=4, tone=4, base=2, degree=\"25\u00b0 59\u2032 33\u2033\", sign=\"Virgo\", house=\"5\", axis=\"92axis\")\n  res = electron_collapse(demo_mbh, sig)\n  print(res.field_sentence)\n  print(res.orbital, round(res.score, 3))\n", "example_runner.py": "from electron_collapse import electron_collapse, FieldSignature, CollapseConfig\nmbh = {\n  \"Body\":  \"ACTION: apis.venmo.send_money('alice', 5, note='Cynthia Lab test')\",\n  \"Mind\":  \"Plan: fund first, verify address; logic: low cost, high goodwill.\",\n  \"Heart\": \"Feels supportive; risk: boundary confusion (0.2).\"\n}\nsig = FieldSignature(gate_line=\"38.4\", color=4, tone=4, base=2, degree=\"25\u00b0 59\u2032 33\u2033\", sign=\"Virgo\", house=\"5\", axis=\"92axis\")\ncfg = CollapseConfig(weights=(1.0,1.0,1.0), core_threshold=0.70, advisory_threshold=0.50, gate_allow={\"38.4\":[\"execute_api\",\"aid\",\"defend\"]})\nres = electron_collapse(mbh, sig, cfg)\nprint(\"FIELD SENTENCE:\", res.field_sentence)\nprint(\"ORBITAL:\", res.orbital)\nprint(\"SCORE:\", round(res.score,3))\nprint(\"CHOSEN:\", (res.chosen.kind if res.chosen else None), (res.chosen.api_call if res.chosen else None))\n"};

function setCode() {
  for (const [path, src] of Object.entries(FILES)) {
    const id = 'src-' + path.replaceAll('/', '-');
    const pre = document.getElementById(id);
    if (pre) pre.textContent = src;
  }
}
setCode();

document.getElementById('makeZip').addEventListener('click', async () => {
  const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
  const { saveAs } = await import('https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js');
  const zip = new JSZip();
  for (const [path, src] of Object.entries(FILES)) {
    zip.file(path, src);
  }
  const blob = await zip.generateAsync({ type: 'blob' });
  saveAs(blob, 'cynthia-cities-pack.zip');
  alert('Zip created: cynthia-cities-pack.zip');
});
</script>
</body>
</html>
